name: E2E Smoke Tests

on:
  pull_request:
  workflow_dispatch:

jobs:
  e2e-smoke:
    name: E2E smoke
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start minimal services with Docker Compose
        run: |
          # Start only the services the smoke test needs to reduce runner load
          docker compose up -d --build redis postgres bid-engine frontend

      - name: Wait for containers to be running
        run: |
          for i in {1..30}; do
            docker compose ps --services --filter "status=running" | wc -l | grep -q '[1-9]' && break || sleep 2
          done

      - name: Run E2E smoke script
        run: |
          bash scripts/e2e_smoke.sh

      - name: Capture diagnostics (logs & ps)
        if: failure()
        run: |
          docker compose ps
          docker compose logs --no-color --tail=300 || true

      - name: Tear down
        if: always()
        run: docker compose down --volumes
